#cloud-config

write_files:
- path: /etc/ytdt/.env
  permissions: 0600
  content: |
    NODE_ENV=production
    PORT=3000
    MONGODB_URI=mongodb://34.23.140.78:27017/ytdt-claims-pipeline
    MYSQL_HOST=arclight-prod-rdsarclightcluster-1o4498ihwj5f8.cluster-c2yfzvruid58.us-east-1.rds.amazonaws.com
    MYSQL_USER=jfpadmin
    MYSQL_DATABASE=jfp_analytics_prod
    SLACK_CHANNEL=

- path: /etc/systemd/system/ytdt-claims-pipeline.service
  permissions: 0644
  content: |
    [Unit]
    Description=API Container
    After=docker.service
    Requires=docker.service
    
    [Service]
    ExecStartPre=/usr/bin/docker pull us-east1-docker.pkg.dev/jfp-data-warehouse/ytdt-claims/ytdt-claims-pipeline:latest
    ExecStartPre=/bin/bash -c 'mkdir -p /run/secrets/vpn && gcloud secrets versions access latest --secret=vpn-config > /run/secrets/vpn/client.ovpn && chmod 600 /run/secrets/vpn/client.ovpn'
    ExecStartPre=/bin/bash -c 'echo "MYSQL_PASSWORD=$(gcloud secrets versions access latest --secret=mysql-password)" >> /etc/ytdt/.env'
    ExecStartPre=/bin/bash -c 'echo "SLACK_BOT_TOKEN=$(gcloud secrets versions access latest --secret=slack-bot-token)" >> /etc/ytdt/.env'
    ExecStartPre=/bin/bash -c 'echo "SLACK_SIGNING_SECRET=$(gcloud secrets versions access latest --secret=slack-signing-secret)" >> /etc/ytdt/.env'
    ExecStart=/usr/bin/docker run --rm --privileged --cap-add=NET_ADMIN --cap-add=SYS_ADMIN -p 80:3000 --env-file /etc/ytdt/.env -v /run/secrets/vpn:/config/vpn --name ytdt-claims-pipeline us-east1-docker.pkg.dev/jfp-data-warehouse/ytdt-claims/ytdt-claims-pipeline:latest
    ExecStop=/usr/bin/docker stop ytdt-claims-pipeline
    Restart=always
    
    [Install]
    WantedBy=multi-user.target

runcmd:
- systemctl daemon-reload
- systemctl enable ytdt-claims-pipeline.service
- systemctl start ytdt-claims-pipeline.service
